// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          Int          @id @default(autoincrement())
  username    String       @unique
  email       String       @unique
  password    String
  role        Role
  participant Participant?
  coordinator Coordinator?

  @@map("users")
}

enum Role {
  COORDINATOR
  PARTICIPANT
}

model Coordinator {
  id   Int    @id @unique
  name String
  user User   @relation(fields: [id], references: [id], onDelete: Cascade)

  @@map("coordinators")
}

model Participant {
  id          Int       @id @unique
  name        String
  description String?
  user        User      @relation(fields: [id], references: [id], onDelete: Cascade)
  products    Product[]

  @@map("participants")
}

model Production {
  id          Int       @id @default(autoincrement())
  name        String
  unit        String
  description String?
  products    Product[]

  @@map("productions")
}

model Product {
  id             Int         @id @default(autoincrement())
  participant_id Int
  production_id  Int
  name           String
  participant    Participant @relation(fields: [participant_id], references: [id], onDelete: Cascade)
  production     Production  @relation(fields: [production_id], references: [id])
  catalogs       Catalog[]

  @@map("product")
}

model Catalog {
  id             Int            @id @default(autoincrement())
  product_id     Int
  plan_id        Int
  desired_volume Float
  product        Product        @relation(fields: [product_id], references: [id])
  plan           ProductionPlan @relation(fields: [plan_id], references: [id])
  supplier       Supply[]       @relation("SupplierRelation")
  consumer       Supply[]       @relation("ConsumerRelation")
  agreement_supplier Agreement[] @relation("SupplierAgreement")
  agreement_consumer Agreement[] @relation("ConsumerAgreement")

  @@unique([plan_id, product_id])
  @@map("catalogs")
}

model Supply {
  id                  Int                   @id @default(autoincrement())
  supplier_catalog_id Int
  consumer_catalog_id Int
  cost_factor         Float
  supplier_catalog    Catalog               @relation("SupplierRelation", fields: [supplier_catalog_id], references: [id], onDelete: Cascade)
  consumer_catalog    Catalog               @relation("ConsumerRelation", fields: [consumer_catalog_id], references: [id], onDelete: Cascade)
  production_detail   ProductionPlanDetail?
  agreement Agreement[]

  @@map("supplies")
}

model ProductionPlan {
  id           Int                    @id @default(autoincrement())
  period_start DateTime
  period_end   DateTime
  status       StatusProductionPlan
  catalogs     Catalog[]
  details      ProductionPlanDetail[]

  @@map("production_plans")
}

enum StatusProductionPlan {
  OPEN
  FINALIZED
  ARCHIVED
}

model ProductionPlanDetail {
  id           Int            @id @default(autoincrement())
  plan_id      Int
  supply_id    Int            @unique
  final_amount Float
  plan         ProductionPlan @relation(fields: [plan_id], references: [id], onDelete: Cascade)
  supply       Supply         @relation(fields: [supply_id], references: [id], onDelete: Cascade)

  @@map("production_plan_details")
}

model Agreement {
  id                Int           @id @default(autoincrement())
  supplier_id       Int
  consumer_id       Int
  cost_factor       Float
  linked_supply_id  Int?
  status            AgreementStatus     @default(PENDING)
  supplier_status   AgreementSideStatus @default(PENDING)
  consumer_status   AgreementSideStatus @default(PENDING)
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt

  supplier          Catalog   @relation("SupplierAgreement", fields: [supplier_id], references: [id], onDelete: Cascade)
  consumer          Catalog   @relation("ConsumerAgreement", fields: [consumer_id], references: [id], onDelete: Cascade)
  linked_supply     Supply?   @relation(fields: [linked_supply_id], references: [id])

  @@map("agreements")
}

enum AgreementStatus {
  PENDING
  ACTIVE
  CANCELLED
  COMPLETED
}

enum AgreementSideStatus {
  PENDING
  ACCEPTED
  CANCELLED
}
